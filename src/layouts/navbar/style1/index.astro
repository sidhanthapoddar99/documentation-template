---
/**
 * Navbar Style 1 - Standard navigation bar
 *
 * Features:
 * - Logo on the left
 * - Navigation links in the center/right
 * - Dropdown menus for grouped items
 * - External link indicators (auto-detected)
 * - Theme toggle
 * - Mobile responsive with hamburger menu
 */

import { loadNavbarConfig, getSiteLogo } from '@loaders/config';
import type { NavItem } from '@loaders/config';

interface Props {
  currentPath?: string;
}

const navbarConfig = loadNavbarConfig();
const { currentPath = Astro.url.pathname } = Astro.props;

// Logo is now loaded from site.yaml
const logo = getSiteLogo();
const items = navbarConfig.items || [];

// Helper to check if a link is external
function isExternal(href: string | undefined): boolean {
  return href?.startsWith('http') || false;
}

// Process nav items
interface ProcessedNavItem extends NavItem {
  isExternal: boolean;
  items?: ProcessedNavItem[];
}

function processNavItem(item: NavItem): ProcessedNavItem {
  return {
    ...item,
    isExternal: isExternal(item.href),
    items: item.items?.map(processNavItem),
  };
}

const processedItems = items.map(processNavItem);

function isActive(href: string | undefined): boolean {
  if (!href) return false;
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
}
---

<nav class="navbar" aria-label="Main navigation">
  <div class="navbar__container">
    <!-- Logo -->
    <a href="/" class="navbar__logo">
      {logo.src ? (
        <img src={logo.src} alt={logo.alt} />
      ) : (
        <span class="navbar__logo-text">{logo.alt}</span>
      )}
    </a>

    <!-- Desktop Navigation -->
    <div class="navbar__links">
      {processedItems.map((item) => (
        item.items && item.items.length > 0 ? (
          <div class="navbar__dropdown">
            <button class="navbar__link navbar__dropdown-trigger">
              {item.label}
              <svg class="navbar__dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </button>
            <div class="navbar__dropdown-menu">
              {item.items.map((child) => (
                <a
                  href={child.href || '#'}
                  class="navbar__dropdown-item"
                  target={child.isExternal ? '_blank' : undefined}
                  rel={child.isExternal ? 'noopener noreferrer' : undefined}
                >
                  {child.label}
                  {child.isExternal && (
                    <svg class="navbar__external-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                      <polyline points="15 3 21 3 21 9" />
                      <line x1="10" y1="14" x2="21" y2="3" />
                    </svg>
                  )}
                </a>
              ))}
            </div>
          </div>
        ) : (
          <a
            href={item.href || '#'}
            class:list={['navbar__link', { 'navbar__link--active': isActive(item.href) }]}
            target={item.isExternal ? '_blank' : undefined}
            rel={item.isExternal ? 'noopener noreferrer' : undefined}
          >
            {item.label}
            {item.isExternal && (
              <svg class="navbar__external-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
              </svg>
            )}
          </a>
        )
      ))}
    </div>

    <!-- Right Section -->
    <div class="navbar__right">
      <!-- Theme Toggle -->
      <button class="navbar__theme-toggle" aria-label="Toggle theme" data-theme-toggle>
        <svg class="navbar__theme-icon navbar__theme-icon--light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5" />
          <line x1="12" y1="1" x2="12" y2="3" />
          <line x1="12" y1="21" x2="12" y2="23" />
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
          <line x1="1" y1="12" x2="3" y2="12" />
          <line x1="21" y1="12" x2="23" y2="12" />
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
        </svg>
        <svg class="navbar__theme-icon navbar__theme-icon--dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        </svg>
      </button>

      <!-- Mobile Menu Toggle -->
      <button class="navbar__mobile-toggle" aria-label="Toggle menu" data-mobile-toggle>
        <svg class="navbar__menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
        <svg class="navbar__close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="navbar__mobile-menu" data-mobile-menu>
    {processedItems.map((item) => (
      <>
        {item.items ? (
          <>
            <span class="navbar__mobile-label">{item.label}</span>
            {item.items.map((child) => (
              <a
                href={child.href || '#'}
                class="navbar__mobile-link navbar__mobile-link--nested"
                target={child.isExternal ? '_blank' : undefined}
                rel={child.isExternal ? 'noopener noreferrer' : undefined}
              >
                {child.label}
              </a>
            ))}
          </>
        ) : (
          <a
            href={item.href || '#'}
            class:list={['navbar__mobile-link', { 'navbar__mobile-link--active': isActive(item.href) }]}
            target={item.isExternal ? '_blank' : undefined}
            rel={item.isExternal ? 'noopener noreferrer' : undefined}
          >
            {item.label}
          </a>
        )}
      </>
    ))}
  </div>
</nav>

<script>
  function initNavbar() {
    // Mobile menu toggle
    document.querySelectorAll('[data-mobile-toggle]').forEach((button) => {
      button.addEventListener('click', () => {
        const navbar = button.closest('.navbar');
        if (navbar) {
          const isOpen = navbar.getAttribute('data-mobile-open') === 'true';
          navbar.setAttribute('data-mobile-open', String(!isOpen));
        }
      });
    });

    // Close on link click
    document.querySelectorAll('.navbar__mobile-link').forEach((link) => {
      link.addEventListener('click', () => {
        const navbar = link.closest('.navbar');
        if (navbar) {
          navbar.setAttribute('data-mobile-open', 'false');
        }
      });
    });

    // Theme toggle
    document.querySelectorAll('[data-theme-toggle]').forEach((button) => {
      button.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      });
    });
  }

  initNavbar();

  // Re-init on Astro page transitions
  document.addEventListener('astro:page-load', initNavbar);
</script>
