---
/**
 * Countdown Layout - Displays a countdown timer to a target date
 */
import { loadFile } from '@loaders/data';

interface Props {
  dataPath: string;
}

const { dataPath } = Astro.props;

let pageData: { title?: string; subtitle?: string; targetDate?: string; amount?: string; note?: string } = {};

try {
  const content = await loadFile(dataPath);
  pageData = content.data as typeof pageData;
} catch (error) {
  console.error('Error loading countdown page data:', error);
}

const title = pageData.title || 'Countdown';
const subtitle = pageData.subtitle || '';
const targetDate = pageData.targetDate || '2026-03-01T00:00:00';
const amount = pageData.amount || '';
const note = pageData.note || '';
---

<section class="countdown-page">
  <div class="countdown-container">
    <h1 class="countdown-title">{title}</h1>
    {subtitle && <p class="countdown-subtitle">{subtitle}</p>}
    {amount && <div class="countdown-amount">{amount}</div>}

    <div class="countdown-timer" id="countdown" data-target={targetDate}>
      <div class="countdown-unit">
        <span class="countdown-value" id="days">--</span>
        <span class="countdown-label">Days</span>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-unit">
        <span class="countdown-value" id="hours">--</span>
        <span class="countdown-label">Hours</span>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-unit">
        <span class="countdown-value" id="minutes">--</span>
        <span class="countdown-label">Minutes</span>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-unit">
        <span class="countdown-value" id="seconds">--</span>
        <span class="countdown-label">Seconds</span>
      </div>
    </div>

    {note && <p class="countdown-note">{note}</p>}
  </div>
</section>

<style>
  .countdown-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    padding: 2rem;
  }

  .countdown-container {
    text-align: center;
    max-width: 700px;
  }

  .countdown-title {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
  }

  .countdown-subtitle {
    font-size: 1.1rem;
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }

  .countdown-amount {
    font-size: 3rem;
    font-weight: 800;
    color: var(--color-error);
    margin-bottom: 2rem;
    letter-spacing: -1px;
  }

  .countdown-timer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  .countdown-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-default);
    border-radius: 12px;
    padding: 1.2rem 1.5rem;
    min-width: 90px;
  }

  .countdown-value {
    font-size: 2.5rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    color: var(--color-text-primary);
    line-height: 1;
  }

  .countdown-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--color-text-muted);
    margin-top: 0.4rem;
  }

  .countdown-separator {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text-muted);
    padding-bottom: 1rem;
  }

  .countdown-note {
    font-size: 0.95rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  @media (max-width: 600px) {
    .countdown-timer {
      gap: 0.25rem;
    }
    .countdown-unit {
      min-width: 65px;
      padding: 0.8rem 0.6rem;
    }
    .countdown-value {
      font-size: 1.8rem;
    }
    .countdown-amount {
      font-size: 2.2rem;
    }
  }
</style>

<script>
  function startCountdown() {
    const el = document.getElementById('countdown');
    if (!el) return;

    const target = new Date(el.dataset.target || '').getTime();

    function update() {
      const now = Date.now();
      const diff = target - now;

      if (diff <= 0) {
        document.getElementById('days')!.textContent = '0';
        document.getElementById('hours')!.textContent = '0';
        document.getElementById('minutes')!.textContent = '0';
        document.getElementById('seconds')!.textContent = '0';
        return;
      }

      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const s = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('days')!.textContent = String(d);
      document.getElementById('hours')!.textContent = String(h).padStart(2, '0');
      document.getElementById('minutes')!.textContent = String(m).padStart(2, '0');
      document.getElementById('seconds')!.textContent = String(s).padStart(2, '0');

      requestAnimationFrame(update);
    }

    update();
  }

  startCountdown();
</script>
