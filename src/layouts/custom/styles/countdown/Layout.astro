---
/**
 * Countdown Layout - Displays a countdown timer to a target date
 */
import { loadFile } from '@loaders/data';

interface Props {
  dataPath: string;
}

const { dataPath } = Astro.props;

let pageData: { title?: string; subtitle?: string; targetDate?: string; amount?: string; note?: string } = {};

try {
  const content = await loadFile(dataPath);
  pageData = content.data as typeof pageData;
} catch (error) {
  console.error('Error loading countdown page data:', error);
}

const title = pageData.title || 'Countdown';
const subtitle = pageData.subtitle || '';
const targetDate = pageData.targetDate || '2026-03-01T00:00:00';
const amount = pageData.amount || '';
const note = pageData.note || '';
---

<section class="countdown-page">
  <div class="countdown-container">
    <h1 class="countdown-title">{title}</h1>
    {subtitle && <p class="countdown-subtitle">{subtitle}</p>}
    {amount && <div class="countdown-amount">{amount}</div>}

    <div class="countdown-timer" id="countdown" data-target={targetDate}>
      <div class="countdown-unit">
        <span class="countdown-value" id="days">--</span>
        <span class="countdown-label">Days</span>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-unit">
        <span class="countdown-value" id="hours">--</span>
        <span class="countdown-label">Hours</span>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-unit">
        <span class="countdown-value" id="minutes">--</span>
        <span class="countdown-label">Minutes</span>
      </div>
      <div class="countdown-separator">:</div>
      <div class="countdown-unit">
        <span class="countdown-value" id="seconds">--</span>
        <span class="countdown-label">Seconds</span>
      </div>
    </div>

    {note && <p class="countdown-note">{note}</p>}
  </div>
</section>

<script>
  function startCountdown() {
    const el = document.getElementById('countdown');
    if (!el) return;

    const target = new Date(el.dataset.target || '').getTime();

    function update() {
      const now = Date.now();
      const diff = target - now;

      if (diff <= 0) {
        document.getElementById('days')!.textContent = '0';
        document.getElementById('hours')!.textContent = '0';
        document.getElementById('minutes')!.textContent = '0';
        document.getElementById('seconds')!.textContent = '0';
        return;
      }

      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const s = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('days')!.textContent = String(d);
      document.getElementById('hours')!.textContent = String(h).padStart(2, '0');
      document.getElementById('minutes')!.textContent = String(m).padStart(2, '0');
      document.getElementById('seconds')!.textContent = String(s).padStart(2, '0');

      requestAnimationFrame(update);
    }

    update();
  }

  startCountdown();
</script>
