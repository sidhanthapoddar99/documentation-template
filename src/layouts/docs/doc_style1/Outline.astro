---
/**
 * Outline - Table of contents for current page
 *
 * Features:
 * - Shows page headings
 * - Scroll spy for active heading
 * - Configurable heading levels
 */

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  title?: string;
}

const { headings, title = 'On this page' } = Astro.props;
---

<aside class="outline">
  <nav class="outline__nav" aria-label="Table of contents">
    <h2 class="outline__title">{title}</h2>
    <ul class="outline__list">
      {headings.map((heading) => (
        <li class:list={['outline__item', `outline__item--depth-${heading.depth}`]}>
          <a
            href={`#${heading.slug}`}
            class="outline__link"
            data-outline-link={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</aside>

<style>
  .outline {
    width: var(--outline-width);
    flex-shrink: 0;
    padding: var(--spacing-lg) var(--spacing-md);
    height: calc(100vh - var(--navbar-height));
    position: sticky;
    top: var(--navbar-height);
    overflow-y: auto;
  }

  .outline__nav {
    padding-left: var(--spacing-md);
    border-left: 1px solid var(--color-border-default);
  }

  .outline__title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
  }

  .outline__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .outline__item--depth-3 {
    padding-left: var(--spacing-md);
  }

  .outline__item--depth-4 {
    padding-left: calc(var(--spacing-md) * 2);
  }

  .outline__link {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .outline__link:hover {
    color: var(--color-text-primary);
  }

  .outline__link--active {
    color: var(--color-brand-primary);
    font-weight: 500;
  }

  /* Hide on smaller screens */
  @media (max-width: 1280px) {
    .outline {
      display: none;
    }
  }
</style>

<script>
  function initOutline() {
    const links = document.querySelectorAll('[data-outline-link]');
    if (links.length === 0) return;

    const headings = Array.from(links).map(link => {
      const slug = link.getAttribute('data-outline-link');
      const heading = document.getElementById(slug || '');
      return { link, heading, slug };
    }).filter(item => item.heading);

    let currentActive: Element | null = null;

    function updateActive() {
      const scrollTop = window.scrollY;
      const offset = 100; // Offset for navbar height

      // Find the heading that's currently in view
      let activeHeading = headings[0];

      for (const item of headings) {
        if (item.heading && item.heading.offsetTop <= scrollTop + offset) {
          activeHeading = item;
        }
      }

      // Update active state
      if (currentActive !== activeHeading.link) {
        currentActive?.classList.remove('outline__link--active');
        activeHeading.link.classList.add('outline__link--active');
        currentActive = activeHeading.link;
      }
    }

    // Throttled scroll handler
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActive();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Initial update
    updateActive();
  }

  initOutline();
  document.addEventListener('astro:page-load', initOutline);
</script>
