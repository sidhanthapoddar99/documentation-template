---
/**
 * Outline - Table of contents / page outline
 */

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  title?: string;
}

const { headings, title = 'On this page' } = Astro.props;

// Filter to only h2 and h3
const filteredHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <aside class="outline">
    <h4 class="outline-title">{title}</h4>
    <nav class="outline-nav">
      <ul class="outline-list">
        {filteredHeadings.map(heading => (
          <li class:list={['outline-item', `depth-${heading.depth}`]}>
            <a href={`#${heading.slug}`} class="outline-link">
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </aside>
)}

<style>
  .outline {
    width: 14rem;
    flex-shrink: 0;
    padding: 1.5rem 1rem;
    height: calc(100vh - 3.5rem);
    overflow-y: auto;
    position: sticky;
    top: 3.5rem;
  }

  .outline-title {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
    color: var(--theme-text-muted);
    margin-bottom: 0.75rem;
  }

  .outline-list {
    list-style: none;
    padding: 0;
    margin: 0;
    border-left: 1px solid var(--theme-border-default);
  }

  .outline-item {
    margin: 0;
  }

  .outline-item.depth-3 {
    padding-left: 0.75rem;
  }

  .outline-link {
    display: block;
    padding: 0.25rem 0.75rem;
    margin-left: -1px;
    font-size: var(--text-sm);
    color: var(--theme-text-secondary);
    text-decoration: none;
    border-left: 2px solid transparent;
    transition: all 0.15s ease;
  }

  .outline-link:hover {
    color: var(--theme-text-primary);
    border-left-color: var(--theme-border-strong);
  }

  .outline-link.active {
    color: var(--color-brand-primary);
    border-left-color: var(--color-brand-primary);
  }
</style>

<script>
  // Highlight current section on scroll
  const observerOptions = {
    rootMargin: '-80px 0px -80% 0px',
    threshold: 0
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const id = entry.target.getAttribute('id');
      const link = document.querySelector(`.outline-link[href="#${id}"]`);

      if (entry.isIntersecting) {
        document.querySelectorAll('.outline-link').forEach(l => l.classList.remove('active'));
        link?.classList.add('active');
      }
    });
  }, observerOptions);

  document.querySelectorAll('h2[id], h3[id]').forEach(heading => {
    observer.observe(heading);
  });
</script>
