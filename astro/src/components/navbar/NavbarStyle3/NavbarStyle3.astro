---
/**
 * NavbarStyle3 - Mega Menu Navbar
 *
 * A full-featured navbar with mega menu dropdowns:
 * - Logo on the left
 * - Full-width mega menu dropdowns with previews
 * - Search bar
 * - Theme toggle on the right
 * - Mobile responsive
 */

import { ThemeToggle } from '../../ThemeToggle';
import type { NavItem } from '../../../hooks/useNavigation';

export interface Props {
  logo?: {
    src: string;
    alt: string;
    href?: string;
  };
  items?: NavItem[];
  currentPath?: string;
  showSearch?: boolean;
  class?: string;
}

const {
  logo = { src: '/logo.svg', alt: 'Logo', href: '/' },
  items = [],
  currentPath = Astro.url.pathname,
  showSearch = true,
  class: className = '',
} = Astro.props;

// Separate items by type
const megaMenuItems = items.filter(item => item.children && item.children.length > 0);
const flatItems = items.filter(item => !item.children || item.children.length === 0);
---

<nav class:list={['navbar-style3', className]} aria-label="Main navigation">
  <div class="navbar-style3__container">
    <!-- Logo -->
    <a href={logo.href || '/'} class="navbar-style3__logo">
      <img src={logo.src} alt={logo.alt} />
    </a>

    <!-- Navigation Links -->
    <div class="navbar-style3__links">
      {flatItems.filter(i => i.tag === 'home').map((item) => (
        <a
          href={item.href}
          class:list={[
            'navbar-style3__link',
            { 'navbar-style3__link--active': currentPath === item.href }
          ]}
        >
          {item.label}
        </a>
      ))}

      {megaMenuItems.map((item) => (
        <div class="navbar-style3__mega" data-mega>
          <button
            class:list={[
              'navbar-style3__mega-trigger',
              { 'navbar-style3__mega-trigger--active': currentPath.startsWith(item.href) }
            ]}
            aria-expanded="false"
          >
            {item.label}
            <svg class="navbar-style3__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </button>
          <div class="navbar-style3__mega-menu">
            <div class="navbar-style3__mega-content">
              <div class="navbar-style3__mega-grid">
                {item.children?.map((section) => (
                  <div class="navbar-style3__mega-section">
                    <a href={section.href} class="navbar-style3__mega-section-title">
                      {section.label}
                    </a>
                    {section.children && section.children.length > 0 && (
                      <div class="navbar-style3__mega-items">
                        {section.children.slice(0, 5).map((child) => (
                          <a
                            href={child.href}
                            class:list={[
                              'navbar-style3__mega-item',
                              { 'navbar-style3__mega-item--active': currentPath === child.href }
                            ]}
                          >
                            {child.label}
                          </a>
                        ))}
                        {section.children.length > 5 && (
                          <a href={section.href} class="navbar-style3__mega-more">
                            View all →
                          </a>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
              <div class="navbar-style3__mega-footer">
                <a href={item.href} class="navbar-style3__mega-cta">
                  Browse all {item.label.toLowerCase()} →
                </a>
              </div>
            </div>
          </div>
        </div>
      ))}

      {flatItems.filter(i => i.tag !== 'home' && i.tag !== 'external').map((item) => (
        <a
          href={item.href}
          class:list={[
            'navbar-style3__link',
            { 'navbar-style3__link--active': currentPath === item.href || currentPath.startsWith(item.href + '/') }
          ]}
        >
          {item.label}
        </a>
      ))}
    </div>

    <!-- Right Section -->
    <div class="navbar-style3__right">
      {showSearch && (
        <button class="navbar-style3__search-btn" aria-label="Search" data-search-trigger>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <span class="navbar-style3__search-shortcut">⌘K</span>
        </button>
      )}

      {flatItems.filter(i => i.tag === 'external').map((item) => (
        <a
          href={item.href}
          class="navbar-style3__icon-link"
          target="_blank"
          rel="noopener noreferrer"
          aria-label={item.label}
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
          </svg>
        </a>
      ))}

      <ThemeToggle size="md" />

      <button class="navbar-style3__mobile-toggle" aria-label="Toggle menu" data-mobile-toggle>
        <svg class="navbar-style3__menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
        <svg class="navbar-style3__close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="navbar-style3__mobile-menu" data-mobile-menu>
    {showSearch && (
      <div class="navbar-style3__mobile-search">
        <input type="search" placeholder="Search..." class="navbar-style3__mobile-search-input" />
      </div>
    )}

    {flatItems.filter(i => i.tag === 'home').map((item) => (
      <a href={item.href} class="navbar-style3__mobile-link">{item.label}</a>
    ))}

    {megaMenuItems.map((item) => (
      <div class="navbar-style3__mobile-section" data-mobile-section>
        <button class="navbar-style3__mobile-section-trigger">
          {item.label}
          <svg class="navbar-style3__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div class="navbar-style3__mobile-section-items">
          {item.children?.map((section) => (
            <div class="navbar-style3__mobile-subsection">
              <a href={section.href} class="navbar-style3__mobile-subsection-title">{section.label}</a>
              {section.children?.slice(0, 3).map((child) => (
                <a href={child.href} class="navbar-style3__mobile-sublink">{child.label}</a>
              ))}
            </div>
          ))}
        </div>
      </div>
    ))}

    {flatItems.filter(i => i.tag !== 'home' && i.tag !== 'external').map((item) => (
      <a href={item.href} class="navbar-style3__mobile-link">{item.label}</a>
    ))}
  </div>
</nav>

<style>
  .navbar-style3 {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--theme-navbar-bg);
    border-bottom: 1px solid var(--theme-navbar-border);
  }

  .navbar-style3__container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0.75rem 1.5rem;
    gap: 1.5rem;
  }

  .navbar-style3__logo {
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }

  .navbar-style3__logo img {
    height: 2rem;
    width: auto;
  }

  .navbar-style3__links {
    display: none;
    align-items: center;
    gap: 0.25rem;
    flex: 1;
    justify-content: center;
  }

  @media (min-width: 1024px) {
    .navbar-style3__links {
      display: flex;
    }
  }

  .navbar-style3__link {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--theme-text-secondary);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: color 0.15s ease, background-color 0.15s ease;
  }

  .navbar-style3__link:hover {
    color: var(--theme-text-primary);
    background-color: var(--theme-bg-tertiary);
  }

  .navbar-style3__link--active {
    color: var(--color-brand-primary);
  }

  /* Mega Menu */
  .navbar-style3__mega {
    position: static;
  }

  .navbar-style3__mega-trigger {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--theme-text-secondary);
    background: none;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: color 0.15s ease, background-color 0.15s ease;
  }

  .navbar-style3__mega-trigger:hover {
    color: var(--theme-text-primary);
    background-color: var(--theme-bg-tertiary);
  }

  .navbar-style3__mega-trigger--active {
    color: var(--color-brand-primary);
  }

  .navbar-style3__chevron {
    width: 1rem;
    height: 1rem;
    transition: transform 0.15s ease;
  }

  .navbar-style3__mega[data-open="true"] .navbar-style3__chevron {
    transform: rotate(180deg);
  }

  .navbar-style3__mega-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--theme-bg-elevated);
    border-bottom: 1px solid var(--theme-border-default);
    box-shadow: var(--theme-shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.5rem);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
  }

  .navbar-style3__mega[data-open="true"] .navbar-style3__mega-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .navbar-style3__mega-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem;
  }

  .navbar-style3__mega-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
  }

  .navbar-style3__mega-section-title {
    display: block;
    padding: 0.5rem 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--theme-text-heading);
    text-decoration: none;
    border-bottom: 1px solid var(--theme-border-subtle);
    margin-bottom: 0.5rem;
  }

  .navbar-style3__mega-section-title:hover {
    color: var(--color-brand-primary);
  }

  .navbar-style3__mega-items {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .navbar-style3__mega-item {
    padding: 0.375rem 0;
    font-size: 0.875rem;
    color: var(--theme-text-secondary);
    text-decoration: none;
    transition: color 0.15s ease;
  }

  .navbar-style3__mega-item:hover {
    color: var(--theme-text-primary);
  }

  .navbar-style3__mega-item--active {
    color: var(--color-brand-primary);
  }

  .navbar-style3__mega-more {
    padding: 0.375rem 0;
    font-size: 0.75rem;
    color: var(--color-brand-primary);
    text-decoration: none;
  }

  .navbar-style3__mega-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--theme-border-subtle);
  }

  .navbar-style3__mega-cta {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-brand-primary);
    text-decoration: none;
  }

  .navbar-style3__mega-cta:hover {
    text-decoration: underline;
  }

  /* Right Section */
  .navbar-style3__right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .navbar-style3__search-btn {
    display: none;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    color: var(--theme-text-muted);
    background-color: var(--theme-bg-secondary);
    border: 1px solid var(--theme-border-default);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: border-color 0.15s ease;
  }

  .navbar-style3__search-btn:hover {
    border-color: var(--theme-border-strong);
  }

  @media (min-width: 1024px) {
    .navbar-style3__search-btn {
      display: flex;
    }
  }

  .navbar-style3__search-btn svg {
    width: 1rem;
    height: 1rem;
  }

  .navbar-style3__search-shortcut {
    padding: 0.125rem 0.375rem;
    font-size: 0.75rem;
    background-color: var(--theme-bg-tertiary);
    border-radius: 0.25rem;
  }

  .navbar-style3__icon-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    color: var(--theme-text-secondary);
    border-radius: 0.375rem;
    transition: color 0.15s ease, background-color 0.15s ease;
  }

  .navbar-style3__icon-link:hover {
    color: var(--theme-text-primary);
    background-color: var(--theme-bg-tertiary);
  }

  .navbar-style3__icon-link svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  /* Mobile Toggle */
  .navbar-style3__mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border: none;
    background: transparent;
    color: var(--theme-text-primary);
    cursor: pointer;
    border-radius: 0.375rem;
  }

  @media (min-width: 1024px) {
    .navbar-style3__mobile-toggle {
      display: none;
    }
  }

  .navbar-style3__menu-icon,
  .navbar-style3__close-icon {
    width: 1.5rem;
    height: 1.5rem;
  }

  .navbar-style3__close-icon {
    display: none;
  }

  .navbar-style3[data-mobile-open="true"] .navbar-style3__menu-icon {
    display: none;
  }

  .navbar-style3[data-mobile-open="true"] .navbar-style3__close-icon {
    display: block;
  }

  /* Mobile Menu */
  .navbar-style3__mobile-menu {
    display: none;
    flex-direction: column;
    padding: 0.5rem 1rem 1rem;
    border-top: 1px solid var(--theme-border-default);
    max-height: 70vh;
    overflow-y: auto;
  }

  .navbar-style3[data-mobile-open="true"] .navbar-style3__mobile-menu {
    display: flex;
  }

  @media (min-width: 1024px) {
    .navbar-style3__mobile-menu {
      display: none !important;
    }
  }

  .navbar-style3__mobile-search {
    padding: 0.5rem 0;
    margin-bottom: 0.5rem;
  }

  .navbar-style3__mobile-search-input {
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
    background-color: var(--theme-bg-secondary);
    border: 1px solid var(--theme-border-default);
    border-radius: 0.5rem;
    color: var(--theme-text-primary);
  }

  .navbar-style3__mobile-link {
    padding: 0.75rem;
    font-size: 1rem;
    color: var(--theme-text-secondary);
    text-decoration: none;
    border-radius: 0.375rem;
  }

  .navbar-style3__mobile-link:hover {
    color: var(--theme-text-primary);
    background-color: var(--theme-bg-tertiary);
  }

  .navbar-style3__mobile-section-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
    color: var(--theme-text-secondary);
    background: none;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    text-align: left;
  }

  .navbar-style3__mobile-section[data-open="true"] .navbar-style3__chevron {
    transform: rotate(180deg);
  }

  .navbar-style3__mobile-section-items {
    display: none;
    flex-direction: column;
    padding-left: 1rem;
    gap: 0.5rem;
  }

  .navbar-style3__mobile-section[data-open="true"] .navbar-style3__mobile-section-items {
    display: flex;
  }

  .navbar-style3__mobile-subsection {
    padding: 0.5rem 0;
  }

  .navbar-style3__mobile-subsection-title {
    display: block;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--theme-text-heading);
    text-decoration: none;
  }

  .navbar-style3__mobile-sublink {
    display: block;
    padding: 0.25rem 0.5rem;
    padding-left: 1rem;
    font-size: 0.875rem;
    color: var(--theme-text-muted);
    text-decoration: none;
  }
</style>

<script>
  function initNavbar3() {
    // Mega menu triggers
    document.querySelectorAll('.navbar-style3 [data-mega]').forEach((mega) => {
      const trigger = mega.querySelector('.navbar-style3__mega-trigger');

      trigger?.addEventListener('click', () => {
        const isOpen = mega.getAttribute('data-open') === 'true';
        document.querySelectorAll('.navbar-style3 [data-mega]').forEach(m => m.setAttribute('data-open', 'false'));
        mega.setAttribute('data-open', String(!isOpen));
      });
    });

    // Close mega menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!(e.target as Element).closest('[data-mega]')) {
        document.querySelectorAll('.navbar-style3 [data-mega]').forEach(m => m.setAttribute('data-open', 'false'));
      }
    });

    // Mobile toggle
    document.querySelectorAll('.navbar-style3 [data-mobile-toggle]').forEach((button) => {
      button.addEventListener('click', () => {
        const navbar = button.closest('.navbar-style3');
        if (navbar) {
          const isOpen = navbar.getAttribute('data-mobile-open') === 'true';
          navbar.setAttribute('data-mobile-open', String(!isOpen));
        }
      });
    });

    // Mobile sections
    document.querySelectorAll('.navbar-style3 [data-mobile-section]').forEach((section) => {
      const trigger = section.querySelector('.navbar-style3__mobile-section-trigger');
      trigger?.addEventListener('click', () => {
        const isOpen = section.getAttribute('data-open') === 'true';
        section.setAttribute('data-open', String(!isOpen));
      });
    });

    // Keyboard shortcut for search
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        // Trigger search modal (to be implemented)
        console.log('Search triggered');
      }
    });
  }

  initNavbar3();
  document.addEventListener('astro:page-load', initNavbar3);
</script>
