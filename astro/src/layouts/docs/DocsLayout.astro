---
/**
 * DocsLayout - Configuration-driven documentation layout
 *
 * Features: Sidebar navigation, Main content area, Table of contents
 * All components controlled via site.config.ts
 */

import BaseLayout from '../BaseLayout.astro';
import ConfiguredNavbar from '../../components/ConfiguredNavbar.astro';
import ConfiguredFooter from '../../components/ConfiguredFooter.astro';
import { getPageConfig, getPageNameByUrl } from '../../config';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface SidebarItem {
  title: string;
  href?: string;
  children?: { title: string; href: string; order?: number }[];
}

interface Props {
  title: string;
  description?: string;
  headings?: Heading[];
  sidebarItems?: SidebarItem[];
  pageName?: string;
}

const { title, description, headings = [], sidebarItems = [], pageName } = Astro.props;
const currentPath = Astro.url.pathname;

// Get page name from URL if not provided
const resolvedPageName = pageName || getPageNameByUrl(currentPath) || 'docs';

// Get page config with resolved component variants
const pageConfig = getPageConfig(resolvedPageName);

// Check which components to show
const showSidebar = pageConfig.resolvedSidebar !== 'none';
const showOutline = pageConfig.resolvedOutline !== 'none';

// Filter headings for TOC (h2 and h3 only)
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);

// Grid classes based on what's shown
let gridClass = 'md:grid-cols-[1fr]';
if (showSidebar && showOutline) {
  gridClass = 'md:grid-cols-[220px_minmax(0,1fr)] lg:grid-cols-[240px_minmax(0,1fr)_200px]';
} else if (showSidebar) {
  gridClass = 'md:grid-cols-[220px_minmax(0,1fr)] lg:grid-cols-[240px_minmax(0,1fr)]';
} else if (showOutline) {
  gridClass = 'md:grid-cols-[1fr_200px]';
}
---

<BaseLayout title={title} description={description}>
  <ConfiguredNavbar pageName={resolvedPageName} />

  <div class:list={['container mx-auto flex-1 items-start md:grid md:gap-6 lg:gap-10', gridClass]}>
    <!-- Sidebar -->
    {showSidebar && sidebarItems.length > 0 && (
      <aside class="fixed top-14 z-30 -ml-2 hidden h-[calc(100vh-3.5rem)] w-full shrink-0 md:sticky md:block">
        <div class="h-full py-6 pr-6 lg:py-8 overflow-y-auto">
          <nav class="space-y-6">
            {sidebarItems.map((section) => (
              <div>
                <h4 class="mb-1 rounded-md px-2 py-1 text-sm font-semibold text-foreground">
                  {section.title}
                </h4>
                {section.children && (
                  <div class="grid grid-flow-row auto-rows-max text-sm">
                    {section.children.map((item) => (
                      <a
                        href={item.href}
                        class:list={[
                          'group flex w-full items-center rounded-md border border-transparent px-2 py-1 hover:underline',
                          currentPath === item.href
                            ? 'font-medium text-foreground'
                            : 'text-muted-foreground',
                        ]}
                      >
                        {item.title}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </nav>
        </div>
      </aside>
    )}

    <!-- Main content -->
    <main class="relative py-6 lg:py-8">
      <div class="mx-auto w-full min-w-0">
        <div class="mb-4">
          <h1 class="scroll-m-20 text-4xl font-bold tracking-tight">{title}</h1>
          {description && (
            <p class="text-lg text-muted-foreground mt-2">{description}</p>
          )}
        </div>

        <div class="pb-12 pt-8">
          <slot />
        </div>
      </div>
    </main>

    <!-- Table of Contents -->
    {showOutline && tocHeadings.length > 0 && (
      <div class="hidden text-sm xl:block">
        <div class="sticky top-16 -mt-10 pt-4">
          <div class="space-y-2">
            <p class="font-medium">On This Page</p>
            <ul class="m-0 list-none space-y-2 text-muted-foreground">
              {tocHeadings.map((heading) => (
                <li class:list={[heading.depth === 3 && 'ml-4']}>
                  <a
                    href={`#${heading.slug}`}
                    class="inline-block no-underline hover:text-foreground transition-colors"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    )}
  </div>

  <ConfiguredFooter pageName={resolvedPageName} />
</BaseLayout>
