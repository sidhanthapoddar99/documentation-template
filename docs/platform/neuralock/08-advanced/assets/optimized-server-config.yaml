# Optimized Neuralock Server Configuration for High Performance

# Server identification
server:
  id: ${SERVER_ID}
  nft_id: ${NFT_ID}
  region: ${REGION}
  datacenter: ${DATACENTER}

# Network configuration
network:
  host: 0.0.0.0
  port: 8000
  
  # HTTP/2 settings
  http2:
    enabled: true
    initial_window_size: 65535
    max_frame_size: 16384
    max_concurrent_streams: 100
    max_header_list_size: 8192
  
  # TCP optimizations
  tcp:
    nodelay: true
    keepalive: true
    keepalive_timeout: 60000
    socket_timeout: 120000
    
  # Connection limits
  max_connections: 10000
  max_connections_per_ip: 100
  connection_timeout: 30000

# Performance tuning
performance:
  # Worker configuration
  workers:
    count: ${WORKER_COUNT:-16}  # 2x CPU cores
    type: cluster  # cluster | threads
    restart_on_failure: true
    memory_limit: 2GB
    
  # Thread pool
  thread_pool:
    size: 32
    queue_size: 1000
    
  # Request handling
  request:
    max_body_size: 10MB
    timeout: 60000
    max_headers_size: 8192
    
  # Response compression
  compression:
    enabled: true
    threshold: 1024  # bytes
    level: 6  # 1-9
    types:
      - application/json
      - text/plain
      - application/octet-stream

# Caching configuration
cache:
  # L1 Memory cache
  memory:
    enabled: true
    max_size: 1GB
    ttl: 300  # 5 minutes
    eviction_policy: lru
    
  # L2 Redis cache
  redis:
    enabled: true
    cluster_mode: true
    nodes:
      - redis-1:6379
      - redis-2:6379
      - redis-3:6379
    password: ${REDIS_PASSWORD}
    
    # Connection pool
    pool:
      min: 10
      max: 100
      acquire_timeout: 5000
      idle_timeout: 300000
      
    # Performance settings
    pipeline_limit: 100
    retry_strategy:
      retries: 3
      factor: 2
      min_timeout: 1000
      max_timeout: 3000
      
    # Cache settings
    default_ttl: 3600
    max_memory: 2GB
    eviction_policy: allkeys-lru

# Database configuration
database:
  # PostgreSQL settings
  postgres:
    host: ${DB_HOST}
    port: 5432
    database: neuralock
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    
    # Connection pool
    pool:
      min: 10
      max: 50
      acquire_timeout: 30000
      idle_timeout: 10000
      reap_interval: 1000
      
    # Performance tuning
    statement_timeout: 30000
    query_timeout: 30000
    
    # Prepared statements
    prepared_statements:
      enabled: true
      cache_size: 100
      
    # Read replicas
    read_replicas:
      - host: ${DB_REPLICA_1}
        port: 5432
      - host: ${DB_REPLICA_2}
        port: 5432
    
    # Load balancing
    load_balancing:
      strategy: round_robin  # round_robin | least_connections | random
      sticky_sessions: false

# Cryptographic acceleration
crypto:
  # Hardware acceleration
  acceleration:
    aes_ni: true
    sha_extensions: true
    
  # GPU acceleration (if available)
  gpu:
    enabled: ${GPU_ENABLED:-false}
    device_id: 0
    memory_limit: 4GB
    
  # Batch processing
  batch:
    enabled: true
    size: 100
    timeout: 500  # ms
    
  # Worker threads
  workers: 8
  
  # Algorithm preferences
  algorithms:
    encryption: aes-256-gcm
    hashing: sha256
    key_derivation: scrypt
    
  # Key caching
  key_cache:
    enabled: true
    size: 1000
    ttl: 3600

# Session management
sessions:
  # Storage backend
  storage: redis  # memory | redis | postgres
  
  # Session settings
  ttl: 3600  # 1 hour
  refresh_threshold: 300  # 5 minutes
  max_sessions_per_user: 10
  
  # Cookie settings
  cookie:
    name: neuralock_session
    http_only: true
    secure: true
    same_site: strict
    
  # Session pool
  pool:
    size: 10000
    eviction_policy: lru

# Monitoring and metrics
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    path: /metrics
    
  # Health checks
  health:
    enabled: true
    path: /health
    interval: 30000
    
  # Performance tracking
  performance:
    track_response_time: true
    track_memory_usage: true
    track_cpu_usage: true
    sample_rate: 0.1  # 10% sampling
    
  # Alerting thresholds
  alerts:
    high_cpu: 80  # percent
    high_memory: 85  # percent
    high_response_time: 1000  # ms
    high_error_rate: 5  # percent

# Logging configuration
logging:
  # Log level
  level: ${LOG_LEVEL:-info}  # debug | info | warn | error
  
  # Output format
  format: json  # json | text
  
  # Destinations
  destinations:
    - type: console
      level: info
    - type: file
      path: /var/log/neuralock/server.log
      max_size: 100MB
      max_files: 10
      compress: true
    - type: syslog
      host: ${SYSLOG_HOST}
      port: 514
      protocol: tcp
      
  # Performance logging
  slow_query_log:
    enabled: true
    threshold: 1000  # ms
    
  # Audit logging
  audit:
    enabled: true
    include_request_body: false
    include_response_body: false

# Security settings
security:
  # Rate limiting
  rate_limit:
    enabled: true
    window: 60000  # 1 minute
    max_requests: 100
    
    # Per-endpoint limits
    endpoints:
      /api/v1/encrypt: 50
      /api/v1/decrypt: 50
      /api/v1/session: 10
      
  # IP filtering
  ip_filter:
    enabled: false
    whitelist: []
    blacklist: []
    
  # CORS settings
  cors:
    enabled: true
    allowed_origins:
      - https://app.neuralock.io
      - https://admin.neuralock.io
    allowed_methods:
      - GET
      - POST
      - PUT
      - DELETE
    allowed_headers:
      - Content-Type
      - Authorization
    max_age: 86400
    
  # Request validation
  validation:
    max_body_size: 10MB
    max_header_size: 8KB
    max_url_length: 2048

# Batch processing
batch_processing:
  enabled: true
  
  # Queue settings
  queue:
    type: redis  # memory | redis
    max_size: 10000
    
  # Processing settings
  processors:
    encrypt:
      batch_size: 50
      timeout: 5000
      max_retries: 3
    decrypt:
      batch_size: 30
      timeout: 8000
      max_retries: 3
      
  # Priority queues
  priorities:
    high: 1
    normal: 5
    low: 10

# Advanced features
advanced:
  # Connection pooling
  connection_pool:
    enabled: true
    min_size: 10
    max_size: 100
    validation_interval: 30000
    
  # Circuit breaker
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    success_threshold: 2
    timeout: 60000
    
  # Retry policies
  retry:
    max_attempts: 3
    initial_delay: 1000
    max_delay: 10000
    multiplier: 2
    
  # Graceful shutdown
  shutdown:
    timeout: 30000
    drain_connections: true
    
  # Hot reload
  hot_reload:
    enabled: false
    watch_paths:
      - /etc/neuralock/config.yaml
      
# Environment-specific overrides
environments:
  development:
    performance:
      workers:
        count: 2
    cache:
      memory:
        max_size: 256MB
    logging:
      level: debug
      
  production:
    performance:
      workers:
        count: ${WORKER_COUNT}
    security:
      rate_limit:
        max_requests: 1000
    monitoring:
      performance:
        sample_rate: 0.01  # 1% sampling