# HAProxy Configuration for Neuralock Multi-Server Deployment
global
    maxconn 4096
    log stdout local0
    log stdout local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.h2.initial-window-size 65536
    tune.h2.max-concurrent-streams 100
    
    # SSL/TLS configuration
    ssl-default-bind-ciphers ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:!PSK:!DHE:!RSA:!DSS:!aNull:!MD5
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn 3000
    
    # Enable compression
    compression algo gzip
    compression type text/html text/plain text/css application/json application/javascript

# Statistics dashboard
stats enable
stats uri /stats
stats refresh 30s
stats realm HAProxy\ Statistics
stats auth admin:${HAPROXY_STATS_PASSWORD}

# Frontend for API traffic
frontend neuralock_api_frontend
    bind *:443 ssl crt /etc/haproxy/certs/neuralock.pem alpn h2,http/1.1
    bind *:80
    
    # Force HTTPS
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 100 }
    
    # ACLs for routing
    acl is_health_check path_beg /health
    acl is_metrics path_beg /metrics
    acl is_session path_beg /api/v1/session
    acl is_encrypt path_beg /api/v1/encrypt
    acl is_decrypt path_beg /api/v1/decrypt
    
    # Route to appropriate backend
    use_backend health_backend if is_health_check
    use_backend metrics_backend if is_metrics
    use_backend session_backend if is_session
    use_backend encrypt_backend if is_encrypt
    use_backend decrypt_backend if is_decrypt
    default_backend neuralock_servers

# Backend for general API requests
backend neuralock_servers
    balance leastconn
    option httpchk GET /health
    http-check expect status 200
    
    # Cookie-based session persistence
    cookie SERVERID insert indirect nocache
    
    # Server configuration with health checks
    server server1 10.1.1.10:8000 check inter 5s rise 2 fall 3 weight 100 cookie s1
    server server2 10.1.1.11:8000 check inter 5s rise 2 fall 3 weight 100 cookie s2
    server server3 10.1.1.12:8000 check inter 5s rise 2 fall 3 weight 90 cookie s3
    server server4 10.2.1.10:8000 check inter 5s rise 2 fall 3 weight 80 cookie s4
    server server5 10.2.1.11:8000 check inter 5s rise 2 fall 3 weight 80 cookie s5
    server server6 10.3.1.10:8000 check inter 5s rise 2 fall 3 weight 70 cookie s6
    server server7 10.3.1.11:8000 check inter 5s rise 2 fall 3 weight 70 cookie s7
    server server8 10.4.1.10:8000 check inter 5s rise 2 fall 3 weight 60 cookie s8
    server server9 10.4.1.11:8000 check inter 5s rise 2 fall 3 weight 60 cookie s9
    
    # Circuit breaker
    option allbackups
    server backup1 10.5.1.10:8000 check inter 5s rise 2 fall 3 backup
    server backup2 10.5.1.11:8000 check inter 5s rise 2 fall 3 backup

# Specialized backend for session creation (high priority)
backend session_backend
    balance roundrobin
    option httpchk GET /health
    
    # Prefer primary servers for session creation
    server server1 10.1.1.10:8000 check weight 100
    server server2 10.1.1.11:8000 check weight 100
    server server3 10.1.1.12:8000 check weight 90

# Backend for encryption operations (geographic awareness)
backend encrypt_backend
    balance uri depth 3
    hash-type consistent
    option httpchk GET /health
    
    # Distribute based on request URI for cache efficiency
    server server1 10.1.1.10:8000 check weight 100
    server server2 10.1.1.11:8000 check weight 100
    server server3 10.1.1.12:8000 check weight 90
    server server4 10.2.1.10:8000 check weight 80
    server server5 10.2.1.11:8000 check weight 80

# Backend for decryption operations (requires k servers)
backend decrypt_backend
    balance leastconn
    option httpchk GET /health
    
    # Ensure at least k servers are available
    option allbackups
    
    server server1 10.1.1.10:8000 check weight 100
    server server2 10.1.1.11:8000 check weight 100
    server server3 10.1.1.12:8000 check weight 90
    server server4 10.2.1.10:8000 check weight 80
    server server5 10.2.1.11:8000 check weight 80
    server server6 10.3.1.10:8000 check weight 70
    server server7 10.3.1.11:8000 check weight 70
    server server8 10.4.1.10:8000 check weight 60
    server server9 10.4.1.11:8000 check weight 60

# Health check backend (all servers)
backend health_backend
    balance roundrobin
    
    # No health check on health endpoint to avoid recursion
    server server1 10.1.1.10:8000
    server server2 10.1.1.11:8000
    server server3 10.1.1.12:8000
    server server4 10.2.1.10:8000
    server server5 10.2.1.11:8000
    server server6 10.3.1.10:8000
    server server7 10.3.1.11:8000
    server server8 10.4.1.10:8000
    server server9 10.4.1.11:8000

# Metrics backend (for Prometheus scraping)
backend metrics_backend
    balance roundrobin
    
    # Expose metrics from all servers
    server server1 10.1.1.10:9090
    server server2 10.1.1.11:9090
    server server3 10.1.1.12:9090
    server server4 10.2.1.10:9090
    server server5 10.2.1.11:9090
    server server6 10.3.1.10:9090
    server server7 10.3.1.11:9090
    server server8 10.4.1.10:9090
    server server9 10.4.1.11:9090

# Frontend for admin portal
frontend admin_portal_frontend
    bind *:8443 ssl crt /etc/haproxy/certs/admin.pem
    
    # IP whitelist for admin access
    acl authorized_admin src 10.0.0.0/8 192.168.0.0/16
    http-request deny if !authorized_admin
    
    default_backend admin_portal_backend

backend admin_portal_backend
    balance roundrobin
    option httpchk GET /
    
    server admin1 10.0.1.10:3000 check
    server admin2 10.0.1.11:3000 check

# NGINX Configuration Alternative
# For those preferring NGINX over HAProxy

# upstream neuralock_servers {
#     least_conn;
#     
#     # Primary servers
#     server 10.1.1.10:8000 weight=100 max_fails=3 fail_timeout=30s;
#     server 10.1.1.11:8000 weight=100 max_fails=3 fail_timeout=30s;
#     server 10.1.1.12:8000 weight=90 max_fails=3 fail_timeout=30s;
#     
#     # Secondary servers
#     server 10.2.1.10:8000 weight=80 max_fails=3 fail_timeout=30s;
#     server 10.2.1.11:8000 weight=80 max_fails=3 fail_timeout=30s;
#     
#     # Tertiary servers
#     server 10.3.1.10:8000 weight=70 max_fails=3 fail_timeout=30s;
#     server 10.3.1.11:8000 weight=70 max_fails=3 fail_timeout=30s;
#     
#     # Backup servers
#     server 10.4.1.10:8000 weight=60 max_fails=3 fail_timeout=30s backup;
#     server 10.4.1.11:8000 weight=60 max_fails=3 fail_timeout=30s backup;
#     
#     # Health check
#     check interval=5000 rise=2 fall=3 timeout=5000 type=http;
#     check_http_send "GET /health HTTP/1.1\r\nHost: localhost\r\n\r\n";
#     check_http_expect_alive http_2xx;
# }
# 
# server {
#     listen 443 ssl http2;
#     server_name api.neuralock.io;
#     
#     ssl_certificate /etc/nginx/certs/neuralock.crt;
#     ssl_certificate_key /etc/nginx/certs/neuralock.key;
#     
#     # SSL configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # Security headers
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     add_header X-Frame-Options "DENY" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     
#     # Rate limiting
#     limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
#     limit_req zone=api burst=20 nodelay;
#     
#     location / {
#         proxy_pass http://neuralock_servers;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         # Timeouts
#         proxy_connect_timeout 10s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#         
#         # Buffering
#         proxy_buffering on;
#         proxy_buffer_size 4k;
#         proxy_buffers 8 4k;
#         proxy_busy_buffers_size 8k;
#     }
#     
#     # Health check endpoint
#     location /health {
#         access_log off;
#         proxy_pass http://neuralock_servers;
#     }
#     
#     # Metrics endpoint (restricted)
#     location /metrics {
#         allow 10.0.0.0/8;
#         deny all;
#         proxy_pass http://neuralock_servers;
#     }
# }