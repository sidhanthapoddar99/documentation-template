---
# Ansible playbook for Neuralock multi-server deployment
- name: Deploy Neuralock Multi-Server Infrastructure
  hosts: all
  become: yes
  vars:
    neuralock_version: "{{ lookup('env', 'NEURALOCK_VERSION') | default('latest') }}"
    environment: "{{ lookup('env', 'ENVIRONMENT') | default('production') }}"
    
  tasks:
    - name: Set server-specific variables
      set_fact:
        server_id: "{{ inventory_hostname }}"
        server_index: "{{ groups['neuralock_servers'].index(inventory_hostname) + 1 }}"
        region: "{{ hostvars[inventory_hostname]['region'] }}"
        datacenter: "{{ hostvars[inventory_hostname]['datacenter'] }}"

- name: Common server setup
  hosts: neuralock_servers
  become: yes
  roles:
    - common
    - security
    - monitoring
  
  tasks:
    - name: Install required packages
      apt:
        name:
          - docker.io
          - docker-compose
          - python3-pip
          - jq
          - curl
          - htop
          - iotop
          - net-tools
        state: present
        update_cache: yes
    
    - name: Configure system limits
      copy:
        dest: /etc/security/limits.d/neuralock.conf
        content: |
          * soft nofile 65536
          * hard nofile 65536
          * soft nproc 32768
          * hard nproc 32768
    
    - name: Configure sysctl for performance
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.core.rmem_max', value: '134217728' }
        - { name: 'net.core.wmem_max', value: '134217728' }
        - { name: 'net.ipv4.tcp_rmem', value: '4096 87380 134217728' }
        - { name: 'net.ipv4.tcp_wmem', value: '4096 65536 134217728' }
        - { name: 'net.ipv4.tcp_congestion_control', value: 'bbr' }
        - { name: 'net.core.default_qdisc', value: 'fq' }
        - { name: 'vm.swappiness', value: '10' }

- name: Deploy Neuralock servers
  hosts: neuralock_servers
  become: yes
  vars:
    neuralock_home: /opt/neuralock
    neuralock_config: /etc/neuralock
    neuralock_data: /var/lib/neuralock
    
  tasks:
    - name: Create neuralock user
      user:
        name: neuralock
        system: yes
        shell: /bin/false
        home: "{{ neuralock_home }}"
        create_home: yes
    
    - name: Create directories
      file:
        path: "{{ item }}"
        state: directory
        owner: neuralock
        group: neuralock
        mode: '0755'
      loop:
        - "{{ neuralock_home }}"
        - "{{ neuralock_config }}"
        - "{{ neuralock_data }}"
        - "{{ neuralock_config }}/certs"
        - "{{ neuralock_config }}/keys"
        - /var/log/neuralock
    
    - name: Generate server configuration
      template:
        src: templates/config.yaml.j2
        dest: "{{ neuralock_config }}/config.yaml"
        owner: neuralock
        group: neuralock
        mode: '0640'
      vars:
        server_config:
          server_id: "{{ server_id }}"
          server_index: "{{ server_index }}"
          region: "{{ region }}"
          datacenter: "{{ datacenter }}"
          threshold_k: "{{ threshold_k }}"
          threshold_n: "{{ threshold_n }}"
    
    - name: Deploy TLS certificates
      copy:
        src: "files/certs/{{ item }}"
        dest: "{{ neuralock_config }}/certs/"
        owner: neuralock
        group: neuralock
        mode: '0640'
      loop:
        - "{{ server_id }}.crt"
        - "{{ server_id }}.key"
        - ca.crt
    
    - name: Generate server keys
      shell: |
        if [ ! -f {{ neuralock_config }}/keys/encryption.key ]; then
          openssl rand -hex 32 > {{ neuralock_config }}/keys/encryption.key
          openssl ecparam -genkey -name secp256k1 -out {{ neuralock_config }}/keys/signing.key
        fi
      args:
        creates: "{{ neuralock_config }}/keys/encryption.key"
    
    - name: Set key permissions
      file:
        path: "{{ neuralock_config }}/keys"
        state: directory
        owner: neuralock
        group: neuralock
        mode: '0700'
        recurse: yes
    
    - name: Deploy Docker Compose file
      template:
        src: templates/docker-compose.yml.j2
        dest: "{{ neuralock_home }}/docker-compose.yml"
        owner: neuralock
        group: neuralock
        mode: '0644'
    
    - name: Create systemd service
      template:
        src: templates/neuralock.service.j2
        dest: /etc/systemd/system/neuralock.service
      notify: restart neuralock
    
    - name: Enable and start Neuralock service
      systemd:
        name: neuralock
        enabled: yes
        state: started
        daemon_reload: yes

- name: Configure load balancers
  hosts: load_balancers
  become: yes
  vars:
    haproxy_config: /etc/haproxy
    
  tasks:
    - name: Install HAProxy
      apt:
        name: haproxy
        state: present
    
    - name: Configure HAProxy
      template:
        src: templates/haproxy.cfg.j2
        dest: "{{ haproxy_config }}/haproxy.cfg"
        backup: yes
      notify: reload haproxy
    
    - name: Enable HAProxy
      systemd:
        name: haproxy
        enabled: yes
        state: started

- name: Setup monitoring
  hosts: monitoring_servers
  become: yes
  roles:
    - prometheus
    - grafana
    - alertmanager
  
  tasks:
    - name: Configure Prometheus scrape targets
      template:
        src: templates/prometheus-targets.yml.j2
        dest: /etc/prometheus/targets/neuralock.yml
      notify: reload prometheus
    
    - name: Import Grafana dashboards
      uri:
        url: "http://localhost:3000/api/dashboards/db"
        method: POST
        user: admin
        password: "{{ grafana_admin_password }}"
        force_basic_auth: yes
        body_format: json
        body: "{{ lookup('file', 'files/grafana-dashboards/neuralock-overview.json') }}"
        status_code: 200

- name: Post-deployment validation
  hosts: neuralock_servers
  tasks:
    - name: Wait for servers to be ready
      uri:
        url: "http://{{ inventory_hostname }}:8000/health"
        status_code: 200
      retries: 30
      delay: 10
    
    - name: Verify server registration
      uri:
        url: "http://{{ inventory_hostname }}:8000/info"
      register: server_info
    
    - name: Display server info
      debug:
        msg: |
          Server {{ server_id }} is running:
          - Version: {{ server_info.json.version }}
          - NFT ID: {{ server_info.json.nft_id }}
          - Public Key: {{ server_info.json.encryption_public_key }}
    
    - name: Test threshold configuration
      uri:
        url: "http://{{ hostvars[groups['neuralock_servers'][0]]['inventory_hostname'] }}:8000/threshold/test"
        method: POST
        body_format: json
        body:
          test_data: "Hello Neuralock"
      register: threshold_test
      run_once: true
    
    - name: Display threshold test result
      debug:
        msg: "Threshold test {{ 'passed' if threshold_test.json.success else 'failed' }}"
      run_once: true

- name: Generate deployment report
  hosts: localhost
  tasks:
    - name: Create deployment summary
      template:
        src: templates/deployment-report.md.j2
        dest: "./deployment-report-{{ ansible_date_time.epoch }}.md"
      vars:
        deployment_time: "{{ ansible_date_time.iso8601 }}"
        total_servers: "{{ groups['neuralock_servers'] | length }}"
        regions: "{{ groups['neuralock_servers'] | map('extract', hostvars, 'region') | unique | list }}"
    
    - name: Display deployment summary
      debug:
        msg: |
          Neuralock Multi-Server Deployment Complete!
          - Total Servers: {{ groups['neuralock_servers'] | length }}
          - Regions: {{ groups['neuralock_servers'] | map('extract', hostvars, 'region') | unique | join(', ') }}
          - Threshold: {{ threshold_k }}-of-{{ threshold_n }}
          - Environment: {{ environment }}

# Handlers
handlers:
  - name: restart neuralock
    systemd:
      name: neuralock
      state: restarted
    listen: restart neuralock
  
  - name: reload haproxy
    systemd:
      name: haproxy
      state: reloaded
    listen: reload haproxy
  
  - name: reload prometheus
    systemd:
      name: prometheus
      state: reloaded
    listen: reload prometheus

# Inventory file example (inventory/production.yml):
# all:
#   children:
#     neuralock_servers:
#       hosts:
#         server-us-east-1:
#           ansible_host: 10.1.1.10
#           region: us-east
#           datacenter: aws-us-east-1a
#         server-us-east-2:
#           ansible_host: 10.1.1.11
#           region: us-east
#           datacenter: aws-us-east-1b
#         server-us-west-1:
#           ansible_host: 10.2.1.10
#           region: us-west
#           datacenter: aws-us-west-2a
#         server-eu-west-1:
#           ansible_host: 10.3.1.10
#           region: eu-west
#           datacenter: aws-eu-west-1a
#     load_balancers:
#       hosts:
#         lb-us-east:
#           ansible_host: 10.1.0.10
#         lb-us-west:
#           ansible_host: 10.2.0.10
#         lb-eu-west:
#           ansible_host: 10.3.0.10
#     monitoring_servers:
#       hosts:
#         monitoring-primary:
#           ansible_host: 10.0.0.10
#   vars:
#     ansible_user: ubuntu
#     ansible_ssh_private_key_file: ~/.ssh/neuralock-prod.pem
#     threshold_k: 5
#     threshold_n: 9