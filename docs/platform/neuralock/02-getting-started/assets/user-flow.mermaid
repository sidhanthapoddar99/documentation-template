sequenceDiagram
    participant User
    participant Wallet as MetaMask
    participant App as Document Vault
    participant Neuralock
    participant Contract as Smart Contract
    participant IPFS
    participant Servers as Neuralock Servers
    
    Note over User,Servers: User Journey: Create and Share Encrypted Document
    
    %% Login Flow
    User->>App: Visit application
    App->>User: Show connect wallet
    User->>Wallet: Approve connection
    Wallet-->>App: Connected (address)
    
    %% Initialize Neuralock
    App->>Neuralock: Initialize client
    Neuralock->>Wallet: Sign session message
    User->>Wallet: Approve signature
    Wallet-->>Neuralock: Signature
    Neuralock->>Servers: Establish sessions
    Servers-->>Neuralock: Session confirmed
    Neuralock-->>App: Initialized
    
    %% Create Document
    User->>App: Click "New Document"
    App->>User: Show create form
    User->>App: Enter title & content
    User->>App: Enable encryption ✓
    User->>App: Submit
    
    %% Encryption Process
    App->>Neuralock: Encrypt document
    Neuralock->>Neuralock: Generate AES key
    Neuralock->>Neuralock: Encrypt content
    Neuralock->>Servers: Distribute key shares
    Servers-->>Neuralock: Shares stored
    Neuralock-->>App: Encrypted data
    
    %% Storage
    App->>IPFS: Upload encrypted content
    IPFS-->>App: IPFS hash
    
    %% Create NFT
    App->>Contract: createDocument(title, hash, encrypted)
    Contract->>Wallet: Request transaction
    User->>Wallet: Approve transaction
    Wallet-->>Contract: Transaction sent
    Contract-->>App: Document NFT created (tokenId)
    
    %% Update display
    App->>User: Show success ✓
    App->>App: Refresh document list
    
    Note over User,Servers: Share Document with Another User
    
    %% Share Document
    User->>App: Click share on document
    App->>User: Show share modal
    User->>App: Enter recipient address
    User->>App: Select "Read Only" permission
    User->>App: Save
    
    %% Update Permissions
    App->>Contract: grantPermission(tokenId, address, 1)
    Contract->>Wallet: Request transaction
    User->>Wallet: Approve
    Wallet-->>Contract: Transaction sent
    Contract-->>App: Permission granted
    
    App->>Neuralock: Update permissions
    Neuralock->>Servers: Update access control
    Servers-->>Neuralock: Updated
    
    App->>User: Share successful ✓
    
    Note over User,Servers: Recipient Views Shared Document
    
    %% Recipient Access
    User->>App: Open shared document
    App->>Contract: Check permissions
    Contract-->>App: Has read access ✓
    
    App->>IPFS: Fetch encrypted content
    IPFS-->>App: Encrypted data
    
    App->>Neuralock: Decrypt document
    Neuralock->>Servers: Request key shares
    Servers->>Servers: Verify permissions
    Servers-->>Neuralock: Return shares (2 of 3)
    Neuralock->>Neuralock: Reconstruct key
    Neuralock->>Neuralock: Decrypt content
    Neuralock-->>App: Decrypted document
    
    App->>User: Display document